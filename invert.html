<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
      body {
        font-family: 'Courier New', monospace;
        background-color: #1a1a1a;
        color: #00ff00;
        margin: 0;
        padding: 20px;
      }
      
      #tonename {
        text-align: center;
        font-size: 30vmin;
        margin-bottom: 20px;
        color: #ffffff;
      }
      
      .meter-container {
        max-width: 800px;
        margin: 0 auto;
        background-color: #2a2a2a;
        border: 2px solid #00ff00;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
      }
      
      .meter-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 15px 0;
        padding: 10px;
        background-color: #333;
        border-radius: 5px;
      }
      
      .meter-label {
        font-weight: bold;
        min-width: 120px;
      }
      
      .meter-value {
        font-size: 1.2em;
        color: #00ffff;
        min-width: 100px;
        text-align: right;
      }
      
      .frequency-bar {
        width: 300px;
        height: 20px;
        background-color: #444;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
      }
      
      .frequency-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00);
        width: 0%;
        transition: width 0.1s ease;
      }
      
      .status-indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #666;
        transition: background-color 0.3s ease;
      }
      
      .status-correct {
        background-color: #00ff00;
        box-shadow: 0 0 10px #00ff00;
      }
      
      .progress-bar {
        width: 200px;
        height: 10px;
        background-color: #444;
        border-radius: 5px;
        overflow: hidden;
      }
      
      .progress-fill {
        height: 100%;
        background-color: #00ff00;
        width: 0%;
        transition: width 0.1s ease;
      }
    </style>
</head>
<body>
    <div style="text-align: center; margin-bottom: 20px;">
        <a href="index.html" style="color: #00ff00; text-decoration: none; font-size: 16px; padding: 8px 16px; border: 2px solid #00ff00; border-radius: 5px; transition: all 0.3s ease;">ğŸ¹ ãƒ”ã‚¢ãƒéŸ³æ„Ÿã‚²ãƒ¼ãƒ ã¸</a>
    </div>
    
    <div style="text-align: center; margin-bottom: 20px; color: #ffff00; font-size: 14px;">
        <p>ğŸ¤ éŸ³ç¨‹ç·´ç¿’ã‚²ãƒ¼ãƒ </p>
        <p>è¡¨ç¤ºã•ã‚ŒãŸéŸ³åã‚’æ­£ç¢ºã«3ç§’é–“æ­Œã†ã‹æ¥½å™¨ã§æ¼”å¥ã—ã¦ãã ã•ã„</p>
        <p>ç”»é¢ã‚’ã‚¿ãƒƒãƒã™ã‚‹ã¨å‚è€ƒéŸ³ãŒå†ç”Ÿã•ã‚Œã¾ã™</p>
        <p style="color: #ff6600; font-size: 12px;">â€»iPhoneã®å ´åˆï¼šã€Œãƒã‚¤ã‚¯ã‚’é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’å¿…ãšã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„</p>
    </div>
    
    <h1 id="tonename"></h1>
    
    <div class="meter-container">
      <div class="meter-row">
        <span class="meter-label">å‘¨æ³¢æ•°:</span>
        <span class="meter-value" id="frequency-display">0.0 Hz</span>
        <div class="frequency-bar">
          <div class="frequency-fill" id="frequency-bar"></div>
        </div>
      </div>
      
      <div class="meter-row">
        <span class="meter-label">æ¤œå‡ºéŸ³å:</span>
        <span class="meter-value" id="detected-note">---</span>
        <div class="status-indicator" id="match-indicator"></div>
      </div>
      
      <div class="meter-row">
        <span class="meter-label">ç›®æ¨™éŸ³å:</span>
        <span class="meter-value" id="target-note">---</span>
        <div class="status-indicator"></div>
      </div>
      
      <div class="meter-row">
        <span class="meter-label">çµŒéæ™‚é–“:</span>
        <span class="meter-value" id="timer-display">0.0 ç§’</span>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-bar"></div>
        </div>
      </div>
      
      <div class="meter-row">
        <span class="meter-label">çŠ¶æ…‹:</span>
        <span class="meter-value" id="status-display">å¾…æ©Ÿä¸­</span>
        <div class="status-indicator" id="status-indicator"></div>
      </div>
    </div>
    <script>
      const tonenames = "ãƒ‰ã‚¬ãƒ¬ãƒãƒŸãƒ•ã‚¡ã‚±ã‚¾ãƒ“ãƒŠãƒ†ã‚·"
      
      // éŸ³åã¨å‘¨æ³¢æ•°ã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆè¤‡æ•°ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–å¯¾å¿œï¼‰
      const noteFrequencies = {
        'ãƒ‰': [130.81, 261.63, 523.25, 1046.50], // C2, C4, C5, C6
        'ã‚¬': [138.59, 277.18, 554.37, 1108.73], // C#2, C#4, C#5, C#6
        'ãƒ¬': [146.83, 293.66, 587.33, 1174.66], // D2, D4, D5, D6
        'ãƒ': [155.56, 311.13, 622.25, 1244.51], // D#2, D#4, D#5, D#6
        'ãƒŸ': [164.81, 329.63, 659.25, 1318.51], // E2, E4, E5, E6
        'ãƒ•ã‚¡': [174.61, 349.23, 698.46, 1396.91], // F2, F4, F5, F6
        'ã‚±': [185.00, 369.99, 739.99, 1479.98], // F#2, F#4, F#5, F#6
        'ã‚¾': [196.00, 392.00, 783.99, 1567.98], // G2, G4, G5, G6
        'ãƒ“': [207.65, 415.30, 830.61, 1661.22], // G#2, G#4, G#5, G#6
        'ãƒŠ': [220.00, 440.00, 880.00, 1760.00], // A2, A4, A5, A6
        'ãƒ†': [233.08, 466.16, 932.33, 1864.66], // A#2, A#4, A#5, A#6
        'ã‚·': [246.94, 493.88, 987.77, 1975.53]  // B2, B4, B5, B6
      }
      
      let audioContext
      let analyser
      let microphone
      let dataArray
      let currentNote = ''
      let correctTime = 0
      let lastTime = 0
      let pianoOscillator = null
      let pianoGain = null
      let isPlaying = false
      
      function generateNewNote() {
        currentNote = tonenames[Math.floor(Math.random() * tonenames.length)]
        tonename.textContent = currentNote
        document.getElementById('target-note').textContent = currentNote
        correctTime = 0
        updateUI()
      }
      
      function getFrequencyForNote(note) {
        // åŸºæœ¬å‘¨æ³¢æ•°ï¼ˆ4ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ç›®ï¼‰ã‚’è¿”ã™
        const frequencies = noteFrequencies[note]
        return frequencies ? frequencies[1] : 440 // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯A4
      }
      
      function startPianoSound() {
        if (isPlaying || !audioContext) return
        
        try {
          const frequency = getFrequencyForNote(currentNote)
          
          // ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½œæˆ
          pianoOscillator = audioContext.createOscillator()
          pianoGain = audioContext.createGain()
          
          // ãƒ”ã‚¢ãƒã‚‰ã—ã„éŸ³è‰²ã®ãŸã‚ã«è¤‡æ•°ã®æ³¢å½¢ã‚’åˆæˆ
          pianoOscillator.type = 'triangle'
          pianoOscillator.frequency.setValueAtTime(frequency, audioContext.currentTime)
          
          // ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ï¼ˆADSRï¼‰ã‚’è¨­å®š
          pianoGain.gain.setValueAtTime(0, audioContext.currentTime)
          pianoGain.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01) // Attack
          pianoGain.gain.exponentialRampToValueAtTime(0.1, audioContext.currentTime + 0.1) // Decay/Sustain
          
          // æ¥ç¶š
          pianoOscillator.connect(pianoGain)
          pianoGain.connect(audioContext.destination)
          
          // å†ç”Ÿé–‹å§‹
          pianoOscillator.start()
          isPlaying = true
          
        } catch (err) {
          console.error('ãƒ”ã‚¢ãƒéŸ³ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', err)
        }
      }
      
      function stopPianoSound() {
        if (!isPlaying || !pianoOscillator) return
        
        try {
          // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
          pianoGain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1)
          
          // åœæ­¢
          pianoOscillator.stop(audioContext.currentTime + 0.1)
          pianoOscillator = null
          pianoGain = null
          isPlaying = false
          
        } catch (err) {
          console.error('ãƒ”ã‚¢ãƒéŸ³ã®åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ:', err)
        }
      }
      
      function updateUI() {
        const frequencyDisplay = document.getElementById('frequency-display')
        const detectedNoteDisplay = document.getElementById('detected-note')
        const timerDisplay = document.getElementById('timer-display')
        const progressBar = document.getElementById('progress-bar')
        const matchIndicator = document.getElementById('match-indicator')
        const statusDisplay = document.getElementById('status-display')
        const statusIndicator = document.getElementById('status-indicator')
        const frequencyBar = document.getElementById('frequency-bar')
        
        return {
          frequencyDisplay,
          detectedNoteDisplay,
          timerDisplay,
          progressBar,
          matchIndicator,
          statusDisplay,
          statusIndicator,
          frequencyBar
        }
      }
      
      function frequencyToNote(frequency) {
        let minDiff = Infinity
        let closestNote = ''
        
        for (const [note, freqArray] of Object.entries(noteFrequencies)) {
          // å„ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã®å‘¨æ³¢æ•°ã‚’ãƒã‚§ãƒƒã‚¯
          for (const freq of freqArray) {
            const diff = Math.abs(frequency - freq)
            if (diff < minDiff) {
              minDiff = diff
              closestNote = note
            }
          }
        }
        
        // è¨±å®¹ç¯„å›²ã‚’Â±30Hzã«æ‹¡å¤§ï¼ˆé«˜ã„ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã«å¯¾å¿œï¼‰
        return minDiff < 30 ? closestNote : null
      }
      
      function getPitch(dataArray) {
        const sampleRate = audioContext.sampleRate
        const bufferLength = dataArray.length
        
        // éŸ³é‡ãƒ¬ãƒ™ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆRMSè¨ˆç®—ï¼‰
        let rms = 0
        for (let i = 0; i < bufferLength; i++) {
          rms += dataArray[i] * dataArray[i]
        }
        rms = Math.sqrt(rms / bufferLength)
        
        // éŸ³é‡é–¾å€¤ã‚’ä¸‹ã’ã‚‹
        if (rms < 0.001) {
          return 0
        }
        
        // FFTã‚’ä½¿ç”¨ã—ãŸå‘¨æ³¢æ•°è§£æ
        const fftSize = bufferLength
        const freqData = new Float32Array(fftSize / 2)
        
        // ç°¡æ˜“FFTï¼ˆå®Ÿéš›ã«ã¯ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒšã‚¯ãƒˆãƒ©ãƒ è¨ˆç®—ï¼‰
        for (let k = 1; k < freqData.length; k++) {
          let real = 0
          let imag = 0
          
          for (let n = 0; n < bufferLength; n++) {
            const angle = -2 * Math.PI * k * n / bufferLength
            real += dataArray[n] * Math.cos(angle)
            imag += dataArray[n] * Math.sin(angle)
          }
          
          freqData[k] = Math.sqrt(real * real + imag * imag)
        }
        
        // äººé–“ã®å£°ãƒ»æ¥½å™¨ã®ç¯„å›²ã‚’æ‹¡å¼µï¼ˆ80Hz-2000Hzï¼‰
        const minFreq = 80
        const maxFreq = 2000
        const minBin = Math.floor(minFreq * fftSize / sampleRate)
        const maxBin = Math.floor(maxFreq * fftSize / sampleRate)
        
        // æœ€å¤§ãƒ‘ãƒ¯ãƒ¼ã‚’æŒã¤å‘¨æ³¢æ•°ã‚’è¦‹ã¤ã‘ã‚‹
        let maxPower = 0
        let peakBin = 0
        
        for (let i = minBin; i < maxBin && i < freqData.length; i++) {
          if (freqData[i] > maxPower) {
            maxPower = freqData[i]
            peakBin = i
          }
        }
        
        // ãƒ‘ãƒ¯ãƒ¼ãŒååˆ†ã«å¼·ã„å ´åˆã®ã¿å‘¨æ³¢æ•°ã‚’è¿”ã™
        if (maxPower > rms * 10 && peakBin > 0) {
          return peakBin * sampleRate / fftSize
        }
        
        return 0
      }
      
      function analyzeAudio() {
        analyser.getFloatTimeDomainData(dataArray)
        
        const frequency = getPitch(dataArray)
        const detectedNote = frequencyToNote(frequency)
        const currentTime = Date.now()
        
        // UIè¦ç´ ã‚’å–å¾—
        const ui = updateUI()
        
        // å‘¨æ³¢æ•°è¡¨ç¤ºã‚’æ›´æ–°
        ui.frequencyDisplay.textContent = frequency > 0 ? `${frequency.toFixed(1)} Hz` : '0.0 Hz'
        
        // å‘¨æ³¢æ•°ãƒãƒ¼ã‚’æ›´æ–°ï¼ˆ80Hz-2000Hzã®ç¯„å›²ã§è¡¨ç¤ºï¼‰
        const minFreq = 80
        const maxFreq = 2000
        const freqPercent = Math.min(Math.max((frequency - minFreq) / (maxFreq - minFreq) * 100, 0), 100)
        ui.frequencyBar.style.width = `${freqPercent}%`
        
        // æ¤œå‡ºã•ã‚ŒãŸéŸ³åã‚’è¡¨ç¤º
        ui.detectedNoteDisplay.textContent = detectedNote || '---'
        
        if (detectedNote === currentNote) {
          if (lastTime === 0) {
            lastTime = currentTime
          }
          correctTime = currentTime - lastTime
          
          // ãƒãƒƒãƒçŠ¶æ…‹ã®UIæ›´æ–°
          ui.matchIndicator.classList.add('status-correct')
          ui.statusDisplay.textContent = 'éŸ³ç¨‹ä¸€è‡´'
          ui.statusIndicator.classList.add('status-correct')
          
          // é€²æ—ãƒãƒ¼ã‚’æ›´æ–°
          const progressPercent = Math.min((correctTime / 3000) * 100, 100)
          ui.progressBar.style.width = `${progressPercent}%`
          
          // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
          ui.timerDisplay.textContent = `${(correctTime / 1000).toFixed(1)} ç§’`
          
          // 3ç§’é–“æ­£ç¢ºãªéŸ³ç¨‹ãŒç¶šã„ãŸå ´åˆ
          if (correctTime >= 3000) {
            generateNewNote()
            lastTime = 0
          }
        } else {
          correctTime = 0
          lastTime = 0
          
          // éãƒãƒƒãƒçŠ¶æ…‹ã®UIæ›´æ–°
          ui.matchIndicator.classList.remove('status-correct')
          ui.statusDisplay.textContent = detectedNote ? 'éŸ³ç¨‹ä¸ä¸€è‡´' : 'éŸ³å£°æ¤œå‡ºä¸­'
          ui.statusIndicator.classList.remove('status-correct')
          ui.progressBar.style.width = '0%'
          ui.timerDisplay.textContent = '0.0 ç§’'
        }
        
        requestAnimationFrame(analyzeAudio)
      }
      
      async function startAudio() {
        showDebugInfo('startAudioé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ')
        
        try {
          // ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯getUserMediaã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“')
          }
          
          showDebugInfo('getUserMediaã‚µãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¾ã—ãŸ')
          
          // iOS Safariç”¨ã®åˆ¶ç´„è¨­å®š
          const constraints = {
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true,
              sampleRate: 44100,
              // iOSç”¨ã®è¿½åŠ è¨­å®š
              channelCount: 1,
              latency: 0.1
            }
          }
          
          showDebugInfo('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚ä¸­...')
          
          // ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
          const stream = await Promise.race([
            navigator.mediaDevices.getUserMedia(constraints),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ')), 10000)
            )
          ])
          
          showDebugInfo('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’å–å¾—ã—ã¾ã—ãŸ')
          
          // AudioContextã‚’ä½œæˆ
          const AudioContextClass = window.AudioContext || window.webkitAudioContext
          if (!AudioContextClass) {
            throw new Error('AudioContextãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“')
          }
          
          audioContext = new AudioContextClass({
            sampleRate: 44100,
            latencyHint: 'interactive'
          })
          
          showDebugInfo(`AudioContextä½œæˆå®Œäº† (state: ${audioContext.state})`)
          
          // AudioContextãŒåœæ­¢çŠ¶æ…‹ã®å ´åˆã¯å†é–‹
          if (audioContext.state === 'suspended') {
            showDebugInfo('AudioContextã‚’å†é–‹ä¸­...')
            await audioContext.resume()
            showDebugInfo(`AudioContextå†é–‹å®Œäº† (state: ${audioContext.state})`)
          }
          
          // ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã¨ãƒã‚¤ã‚¯ãƒ­ãƒ•ã‚©ãƒ³ã‚’è¨­å®š
          analyser = audioContext.createAnalyser()
          microphone = audioContext.createMediaStreamSource(stream)
          
          analyser.fftSize = 4096
          analyser.smoothingTimeConstant = 0.8
          analyser.minDecibels = -90
          analyser.maxDecibels = -10
          
          const bufferLength = analyser.fftSize
          dataArray = new Float32Array(bufferLength)
          
          microphone.connect(analyser)
          
          showDebugInfo('ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè§£æè¨­å®šå®Œäº†')
          
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          const successMsg = document.createElement('div')
          successMsg.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #00ff00;
            color: #000;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            font-weight: bold;
          `
          successMsg.textContent = 'ãƒã‚¤ã‚¯ãŒæ­£å¸¸ã«é–‹å§‹ã•ã‚Œã¾ã—ãŸï¼'
          document.body.appendChild(successMsg)
          
          setTimeout(() => {
            if (successMsg.parentNode) {
              successMsg.remove()
            }
          }, 3000)
          
          // å°‘ã—å¾…ã£ã¦ã‹ã‚‰è§£æé–‹å§‹
          setTimeout(() => {
            generateNewNote()
            analyzeAudio()
            showDebugInfo('éŸ³å£°è§£æã‚’é–‹å§‹ã—ã¾ã—ãŸ')
          }, 500)
          
        } catch (err) {
          showDebugInfo(`ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${err.name} - ${err.message}`)
          console.error('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ:', err)
          
          // è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
          let errorMessage = 'ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'
          
          if (err.name === 'NotAllowedError') {
            errorMessage = 'ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          } else if (err.name === 'NotFoundError') {
            errorMessage = 'ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒã‚¤ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          } else if (err.name === 'NotSupportedError') {
            errorMessage = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚'
          } else if (err.name === 'NotReadableError') {
            errorMessage = 'ãƒã‚¤ã‚¯ãŒä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ä¸­ã§ã™ã€‚'
          } else if (err.message.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
            errorMessage = 'ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
          } else {
            errorMessage = `äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: ${err.message}`
          }
          
          throw new Error(errorMessage)
        }
      }
      
      // ã‚¿ãƒƒãƒãƒ»ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†
      function setupTouchEvents() {
        const body = document.body
        
        // iOS Safariç”¨ã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        const touchOptions = { passive: false }
        
        // ã‚¿ãƒƒãƒé–‹å§‹ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ä»¥å¤–ã®å ´æ‰€ï¼‰
        body.addEventListener('touchstart', (e) => {
          // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã§ãªã„å ´åˆã®ã¿ãƒ”ã‚¢ãƒéŸ³ã‚’å†ç”Ÿ
          if (!e.target.closest('button')) {
            e.preventDefault()
            startPianoSound()
          }
        }, touchOptions)
        
        // ã‚¿ãƒƒãƒçµ‚äº†
        body.addEventListener('touchend', (e) => {
          if (!e.target.closest('button')) {
            e.preventDefault()
            stopPianoSound()
          }
        }, touchOptions)
        
        // ãƒã‚¦ã‚¹å¯¾å¿œï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ï¼‰
        body.addEventListener('mousedown', (e) => {
          if (!e.target.closest('button')) {
            startPianoSound()
          }
        })
        
        body.addEventListener('mouseup', (e) => {
          if (!e.target.closest('button')) {
            stopPianoSound()
          }
        })
        
        // ãƒã‚¦ã‚¹ãŒç”»é¢å¤–ã«å‡ºãŸå ´åˆã‚‚åœæ­¢
        body.addEventListener('mouseleave', (e) => {
          stopPianoSound()
        })
      }
      
      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
      function showDebugInfo(message) {
        console.log(message)
        const debugDiv = document.getElementById('debug-info') || (() => {
          const div = document.createElement('div')
          div.id = 'debug-info'
          div.style.cssText = `
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 1001;
          `
          document.body.appendChild(div)
          return div
        })()
        
        debugDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`
        debugDiv.scrollTop = debugDiv.scrollHeight
      }
      
      // ãƒ–ãƒ©ã‚¦ã‚¶ã¨ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯
      function checkBrowserSupport() {
        const userAgent = navigator.userAgent
        const isIOS = /iPad|iPhone|iPod/.test(userAgent)
        const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent)
        const isHTTPS = location.protocol === 'https:'
        const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)
        
        showDebugInfo(`iOS: ${isIOS}, Safari: ${isSafari}, HTTPS: ${isHTTPS}, getUserMedia: ${hasGetUserMedia}`)
        
        return {
          isIOS,
          isSafari,
          isHTTPS,
          hasGetUserMedia
        }
      }
      
      // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      function createStartButton() {
        const browserInfo = checkBrowserSupport()
        
        const startButton = document.createElement('button')
        startButton.textContent = 'ãƒã‚¤ã‚¯ã‚’é–‹å§‹'
        startButton.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          padding: 20px 40px;
          font-size: 18px;
          background-color: #00ff00;
          color: #000;
          border: none;
          border-radius: 10px;
          cursor: pointer;
          z-index: 1000;
          box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
          touch-action: manipulation;
        `
        
        // iOSç‰¹æœ‰ã®è­¦å‘Šã‚’è¡¨ç¤º
        if (browserInfo.isIOS && !browserInfo.isHTTPS) {
          const warningMsg = document.createElement('div')
          warningMsg.style.cssText = `
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ff6600;
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 999;
            font-size: 14px;
            max-width: 300px;
          `
          warningMsg.innerHTML = `
            <p><strong>âš ï¸ iOSæ³¨æ„äº‹é …</strong></p>
            <p>HTTPSã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„</p>
            <p>ç¾åœ¨ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ${location.protocol}</p>
          `
          document.body.appendChild(warningMsg)
        }
        
        // iOSã§ã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œ
        const handleStart = async (event) => {
          // ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’åœæ­¢
          event.preventDefault()
          event.stopPropagation()
          
          showDebugInfo('ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ')
          
          try {
            startButton.textContent = 'ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ä¸­...'
            startButton.disabled = true
            
            // iOS Safariç”¨ã®è¿½åŠ å¾…æ©Ÿæ™‚é–“
            if (browserInfo.isIOS) {
              showDebugInfo('iOSæ¤œå‡º: è¿½åŠ ã®åˆæœŸåŒ–ã‚’å®Ÿè¡Œä¸­...')
              await new Promise(resolve => setTimeout(resolve, 100))
            }
            
            await startAudio()
            startButton.remove()
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ä¸€å®šæ™‚é–“å¾Œã«éè¡¨ç¤º
            setTimeout(() => {
              const debugDiv = document.getElementById('debug-info')
              if (debugDiv) {
                debugDiv.style.display = 'none'
              }
            }, 10000)
            
          } catch (error) {
            startButton.textContent = 'ã‚¨ãƒ©ãƒ¼: ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„'
            startButton.disabled = false
            
            showDebugInfo(`ã‚¨ãƒ©ãƒ¼: ${error.name} - ${error.message}`)
            
            // è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const errorMsg = document.createElement('div')
            errorMsg.style.cssText = `
              position: fixed;
              top: 60%;
              left: 50%;
              transform: translate(-50%, -50%);
              background-color: #ff0000;
              color: #fff;
              padding: 15px;
              border-radius: 10px;
              text-align: center;
              z-index: 999;
              font-size: 14px;
              max-width: 350px;
            `
            
            let errorHTML = `<p><strong>ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼</strong></p>`
            
            if (error.name === 'NotAllowedError') {
              errorHTML += `
                <p>ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ</p>
                <p>Safariè¨­å®š â†’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ â†’ ãƒã‚¤ã‚¯ ã§ã“ã®ã‚µã‚¤ãƒˆã‚’è¨±å¯ã—ã¦ãã ã•ã„</p>
              `
            } else if (error.name === 'NotFoundError') {
              errorHTML += `<p>ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>`
            } else if (error.name === 'NotSupportedError') {
              errorHTML += `<p>ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒã‚¤ã‚¯ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“</p>`
            } else if (error.name === 'NotReadableError') {
              errorHTML += `<p>ãƒã‚¤ã‚¯ãŒä»–ã®ã‚¢ãƒ—ãƒªã§ä½¿ç”¨ä¸­ã§ã™</p>`
            } else {
              errorHTML += `<p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`
            }
            
            if (!browserInfo.isHTTPS) {
              errorHTML += `<p><strong>HTTPSã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„</strong></p>`
            }
            
            errorMsg.innerHTML = errorHTML
            document.body.appendChild(errorMsg)
            
            setTimeout(() => {
              if (errorMsg.parentNode) {
                errorMsg.remove()
              }
            }, 8000)
          }
        }
        
        // è¤‡æ•°ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¯¾å¿œï¼ˆiOSå¯¾å¿œï¼‰
        startButton.addEventListener('click', handleStart)
        startButton.addEventListener('touchstart', handleStart)
        startButton.addEventListener('touchend', (e) => {
          e.preventDefault()
          e.stopPropagation()
        })
        
        // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´ï¼ˆiOSå¯¾å¿œï¼‰
        startButton.style.cssText += `
          -webkit-appearance: none;
          -webkit-tap-highlight-color: transparent;
          user-select: none;
          -webkit-user-select: none;
        `
        
        document.body.appendChild(startButton)
      }
      
      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«é–‹å§‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      window.addEventListener('load', () => {
        showDebugInfo('ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ')
        generateNewNote()
        setupTouchEvents()
        
        // iOSå¯¾å¿œï¼šã‚ˆã‚Šé•·ã„é…å»¶ã§ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
        setTimeout(() => {
          createStartButton()
          showDebugInfo('ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸ')
        }, 500)
      })
      
      // iOS Safariç”¨ã®è¿½åŠ å¯¾å¿œ
      document.addEventListener('touchstart', function() {}, { passive: false })
      
      // iOS Safariç”¨ã®è¿½åŠ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.addEventListener('DOMContentLoaded', () => {
        showDebugInfo('DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ')
      })
      
      // ãƒšãƒ¼ã‚¸ã®å¯è¦–æ€§å¤‰æ›´ã‚’ç›£è¦–
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          showDebugInfo('ãƒšãƒ¼ã‚¸ãŒéè¡¨ç¤ºã«ãªã‚Šã¾ã—ãŸ')
        } else {
          showDebugInfo('ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ')
        }
      })
    </script>
</body>
</html>
